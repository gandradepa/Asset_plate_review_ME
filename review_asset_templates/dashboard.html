<!DOCTYPE html>
<html>
<head>
    <title>Asset Dashboard</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        .type-badge {
            display: inline-block;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1;
        }
        .type-ME { background: #e7f3ff; color: #084298; }
        .type-EE { background: #e6ffed; color: #0a6b2d; }
        .type-EL { background: #fff3cd; color: #664d03; }
        .type-PL { background: #fde2e2; color: #842029; }
        .type-HV { background: #e8e6ff; color: #3d2b8c; }
        .type-OTHER { background: #f1f3f5; color: #333; }

        .filters-bar .form-select { min-width: 220px; }
        .filters-bar .badge { font-weight: 500; }
        td.approved-cell { cursor: pointer; }
    </style>
</head>
<body class="container-fluid py-4">

    <div class="d-flex justify-content-start align-items-center mb-4">
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='ubc-logo.png') }}" alt="UBC Logo" style="height: 72px; margin-right: 16px;">
        </a>
        <a href="{{ url_for('index') }}" style="text-decoration: none; color: black;">
            <h1 class="m-0">Asset Review Dashboard</h1>
        </a>
    </div>

    <!-- Quick filters -->
    <div class="filters-bar row g-3 align-items-center mb-3">
        <div class="col-auto">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm px-3 {% if not flagged_filter and not modified_filter and not missed_filter %}active{% endif %}">All</a>
            <a href="{{ url_for('index', flagged='true') }}" class="btn btn-outline-danger btn-sm px-3 {% if flagged_filter == 'true' %}active{% endif %}">
                üö© Flagged Only <span class="badge bg-light text-dark" style="min-width: 40px;">{{ count_flagged }}</span>
            </a>
            <a href="{{ url_for('index', modified='true') }}" class="btn btn-outline-warning btn-sm px-3 {% if modified_filter == 'true' %}active{% endif %}">
                ‚úèÔ∏è Modified Only <span class="badge bg-light text-dark" style="min-width: 40px;">{{ count_modified }}</span>
            </a>
            <a href="{{ url_for('index', missed='true') }}" class="btn btn-outline-dark btn-sm px-3 {% if missed_filter == 'true' %}active{% endif %}">
                ‚ùå Missed Photo Only <span class="badge bg-light text-dark" style="min-width: 40px;">{{ count_missed }}</span>
            </a>
        </div>

        <div class="col-md-auto ms-auto">
            <div class="d-flex gap-2">
                <div>
                    <label for="filter-building" class="form-label mb-1 small text-muted">Filter by Building</label>
                    <select id="filter-building" class="form-select form-select-sm">
                        <option value="">All Buildings</option>
                    </select>
                </div>
                <div>
                    <label for="filter-approved" class="form-label mb-1 small text-muted">Filter by Approved</label>
                    <select id="filter-approved" class="form-select form-select-sm">
                        <option value="">All</option>
                        <option value="True">Approved Only</option>
                        <option value="False">Not Approved Only</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <table id="assetTable" class="table table-striped table-bordered align-middle text-center w-100">
        <thead class="table-dark">
            <tr>
                <th class="text-center">QR Code</th>
                <th class="text-center">Building</th>
                <th class="text-center">Type</th>
                <th class="text-start">Manufacturer</th>
                <th class="text-start">Model</th>
                <th class="text-start">Serial</th>
                <th class="text-center">Year</th>
                <th class="text-start">UBC Tag</th>
                <th class="text-start">Technical Safety BC</th>
                <th class="text-start">Asset Group</th>
                <th class="text-start">Attribute</th>
                <th class="text-start">Description</th>
                <th class="text-center">Approved</th> <!-- NEW -->
                <th class="text-center">Flagged</th>
                <th class="text-center">Modified</th>
                <th class="text-center">Missed Photo</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>
        <tbody>
        {% for item in data %}
            <tr>
                <td>{{ item.qr_code }}</td>
                <td>{{ item.building }}</td>
                <td>
                    <span class="type-badge"
                          data-type="{{ (item.asset_type or '') | upper | replace('-', '') | trim }}">
                        {{ (item.asset_type or '') | upper | replace('-', '') | trim }}
                    </span>
                </td>
                <td class="text-start">{{ item.Manufacturer }}</td>
                <td class="text-start">{{ item.Model }}</td>
                <td class="text-start">{{ item['Serial Number'] }}</td>
                <td>{{ item.Year }}</td>
                <td class="text-start">{{ item['UBC Tag'] }}</td>
                <td class="text-start">{{ item['Technical Safety BC'] }}</td>
                <td class="text-start">{{ item['Asset Group'] }}</td>
                <td class="text-start">{{ item['Attribute'] }}</td>
                <td class="text-start">{{ item['Description'] }}</td>

                <!-- Approved cell: display icon, carry searchable value in data-search -->
                {% set approved_bool = 'True' if item['Approved'] == 'True' else 'False' %}
                <td class="approved-cell"
                    data-docid="{{ item.doc_id }}"
                    data-search="{{ approved_bool }}">
                    {% if item['Approved'] == 'True' %}‚úÖ{% else %}{% endif %}
                </td>

                <td>{% if item.Flagged == 'true' %}üö©{% else %}&mdash;{% endif %}</td>
                <td>{% if item.Modified %}‚úèÔ∏è{% else %}&mdash;{% endif %}</td>
                <td>
                  {% if item['Missed Photo'] == 'YES' %}
                    <span class="text-danger"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="Missing: {{ item['Missing List'] }}">
                      ‚ùå {{ item['Photos Summary'] }}
                    </span>
                  {% else %}
                    <span class="text-success"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="All required present">
                      ‚úÖ 3/3
                    </span>
                  {% endif %}
                </td>
                <td>
                    <a class="btn btn-primary btn-sm" href="{{ url_for('review', doc_id=item.doc_id) }}">Review</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <footer class="text-center mt-5 pt-4 border-top text-muted small">
        ¬© 2025 University of British Columbia - Maintenance Planning Department. All rights reserved.
    </footer>

    <!-- jQuery, Bootstrap, DataTables -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
      // Remember dashboard query string for sticky quick-filters across Review
      try { localStorage.setItem('dashboardQuery', window.location.search || ''); } catch (e) {}

      // Tooltips
      document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
      });

      $(document).ready(function () {
          // Column indexes (0-based)
          var colQR = 0, colBuilding = 1, colType = 2, colModel = 4, colYear = 6,
              colAssetGroup = 9, colAttribute = 10, colDescription = 11, colApproved = 12;

          // DataTable with stateSave
          var table = $('#assetTable').DataTable({
              pageLength: 15,
              order: [],
              stateSave: true,
              stateDuration: -1,
              columnDefs: [
                  // Orderable: QR, Building, Type, Model, Year, Asset Group, Attribute, Description
                  { orderable: true, targets: [colQR, colBuilding, colType, colModel, colYear, colAssetGroup, colAttribute, colDescription] },
                  // Make "Approved" not orderable if you prefer; change to true to enable
                  { orderable: false, targets: [colApproved] }
              ],
              // Use 'data-search' attribute for filtering the Approved column
              createdRow: function (row, data, dataIndex) {
                  var $approvedCell = $('td', row).eq(colApproved);
                  var val = $approvedCell.attr('data-search');
                  if (val) {
                      $approvedCell.attr('data-search', val);
                  }
              }
          });

          // Type badge coloring
          function applyTypeBadges() {
              $('#assetTable span.type-badge').each(function () {
                  var t = ($(this).data('type') || '').toString().trim().toUpperCase();
                  $(this).removeClass(function (idx, cn) {
                      return (cn.match(/(^|\s)type-\S+/g) || []).join(' ');
                  });
                  var cls = 'type-OTHER';
                  if (t === 'ME') cls = 'type-ME';
                  else if (t === 'EE') cls = 'type-EE';
                  else if (t === 'EL') cls = 'type-EL';
                  else if (t === 'PL') cls = 'type-PL';
                  else if (t === 'HV') cls = 'type-HV';
                  $(this).addClass(cls);
              });
          }
          applyTypeBadges();
          table.on('draw', applyTypeBadges);

          // Populate Building select from table
          function populateBuilding() {
              var select = $('#filter-building');
              select.find('option:not(:first)').remove();
              var uniques = {};
              table.column(colBuilding, { search: 'applied' }).data().each(function (val) {
                  val = (val || '').toString().trim();
                  if (val) uniques[val] = true;
              });
              Object.keys(uniques).sort().forEach(function (v) {
                  select.append(new Option(v, v));
              });
          }
          populateBuilding();

          // Restore saved DataTables state to selects
          var state = table.state.loaded();
          if (state && state.columns) {
              // Building select (strip ^$ anchors)
              var bSearch = state.columns[colBuilding]?.search?.search || '';
              if (bSearch.startsWith('^') && bSearch.endsWith('$')) {
                  bSearch = bSearch.slice(1, -1);
                  try { bSearch = $.fn.dataTable.util.unescapeRegex(bSearch); } catch(e) {}
              }
              if (bSearch) $('#filter-building').val(bSearch);

              // Approved select
              var aSearch = state.columns[colApproved]?.search?.search || '';
              if (aSearch === '^True$') $('#filter-approved').val('True');
              else if (aSearch === '^False$') $('#filter-approved').val('False');
          }

          table.on('draw', function () {
              populateBuilding();
              if ($('#filter-building').val()) $('#filter-building').val($('#filter-building').val());
          });

          // Building filter
          $('#filter-building').on('change', function () {
              var val = $(this).val();
              table.column(colBuilding).search(val ? '^' + $.fn.dataTable.util.escapeRegex(val) + '$' : '', true, false).draw();
          });

          // Approved filter
          $('#filter-approved').on('change', function () {
              var v = $(this).val();
              // We search against the cell's data-search attr via a custom search plug-in
              if (v === 'True') {
                  table.column(colApproved).search('^True$', true, false).draw();
              } else if (v === 'False') {
                  table.column(colApproved).search('^False$', true, false).draw();
              } else {
                  table.column(colApproved).search('', false, false).draw();
              }
          });

          // Make the Approved column filter actually use the td[data-search] value
          // by overriding column search data source for that column.
          $.fn.dataTable.ext.order['dom-data-search'] = function (settings, col) {
              return this.api().column(col, { order: 'index' }).nodes().map(function (td) {
                  return $(td).attr('data-search') || '';
              });
          };
          $.fn.dataTable.ext.search.push(function (settings, data, dataIndex, rowData, counter) {
              // Ensure column search uses data-search attribute for the Approved column
              var col = colApproved;
              var search = settings.aoPreSearchCols[col].sSearch; // regex if regex=true
              if (!search) return true; // no filter
              var td = settings.aoData[dataIndex].anCells[col];
              var val = $(td).attr('data-search') || '';
              var regex = settings.aoPreSearchCols[col].bRegex ? new RegExp(search) : null;
              if (regex) return regex.test(val);
              return (val.indexOf(search) !== -1);
          });

          // Click to toggle Approved
          $('#assetTable').on('click', '.approved-cell', function() {
              var cell = $(this);
              var docId = cell.data('docid');

              $.post('/toggle_approved/' + docId, function(resp) {
                  if (resp.success) {
                      if (resp.new_value === "True") {
                          cell.html('‚úÖ');
                          cell.attr('data-search', 'True');
                      } else {
                          cell.html('');
                          cell.attr('data-search', 'False');
                      }
                      // Re-apply filter if one is active
                      table.draw(false);
                  } else {
                      alert("Error: " + resp.error);
                  }
              }).fail(function() {
                  alert("Failed to update Approved status.");
              });
          });
      });
    </script>

</body>
</html>
